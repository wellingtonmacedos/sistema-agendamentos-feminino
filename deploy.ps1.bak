# Script de Deploy Automatizado
# Configurações
$ServerIP = "95.217.239.143"
$Port = "22"
$User = "root"
$RemotePath = "/var/www/agenda" 

Write-Host "=== Iniciando Deploy para $ServerIP (Porta App: 3001) ===" -ForegroundColor Cyan

# 1. Build do Frontend
Write-Host "`n[1/3] Gerando Build do Frontend..." -ForegroundColor Yellow
Set-Location "frontend"
npm.cmd run build
if ($LASTEXITCODE -ne 0) {
    Write-Error "Falha no build do frontend!"
    exit 1
}
Set-Location ".."

# 2. Upload
Write-Host "`n[2/3] Iniciando Upload via SCP..." -ForegroundColor Yellow
Write-Host "Destino: $RemotePath"

# Criar diretório remoto se não existir
ssh -p $Port ${User}@${ServerIP} "mkdir -p $RemotePath"

# Lista de arquivos/pastas para enviar
$items = @("src", "package.json", "frontend/dist")

foreach ($item in $items) {
    Write-Host "Enviando: $item"
    if ($item -eq "frontend/dist") {
        # Para evitar aninhamento (dist/dist), removemos o remoto antes
        ssh -p $Port ${User}@${ServerIP} "rm -rf ${RemotePath}/${item}"
    }

    scp -P $Port -r $item "${User}@${ServerIP}:${RemotePath}/${item}"
    
    if ($LASTEXITCODE -ne 0) {
        Write-Warning "Falha ao enviar $item."
    }
}

# 3. Configuração e Restart
Write-Host "`n[3/3] Configurando e Reiniciando..." -ForegroundColor Yellow

# Instalar configuração do Nginx
Write-Host "Instalando configuração do Nginx..." -ForegroundColor Yellow
scp -P $Port "deploy/nginx.conf" "${User}@${ServerIP}:/etc/nginx/sites-available/agenda.cwcompany.com.br"

# Script remoto para:
# 1. Instalar dependências
# 2. Criar/Atualizar .env com PORT=3001
# 3. Reiniciar PM2 na porta correta
$RemoteScript = @"
cd $RemotePath
npm install --production

# Garantir PORT=3001 no .env
if ! grep -q "PORT=3001" .env; then
    echo "PORT=3001" >> .env
    echo "Adicionado PORT=3001 ao .env"
fi

# Reiniciar aplicação (se existir, restart; se não, start)
pm2 describe agenda-backend > /dev/null
if [ \$? -eq 0 ]; then
    pm2 reload agenda-backend --update-env
else
    PORT=3001 pm2 start src/server.js --name agenda-backend
fi
pm2 save

# Linkar e recarregar Nginx
ln -sf /etc/nginx/sites-available/agenda.cwcompany.com.br /etc/nginx/sites-enabled/agenda.cwcompany.com.br
nginx -t && systemctl reload nginx
"@

ssh -p $Port ${User}@${ServerIP} $RemoteScript

Write-Host "`nDeploy finalizado! Acesse: http://agenda.cwcompany.com.br" -ForegroundColor Green
